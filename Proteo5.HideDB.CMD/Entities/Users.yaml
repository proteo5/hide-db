# Description: This file defines the Users entity for the Proteo5.HideDB.CMD project.
entity: "Users"
entityversion: "1"
version: "1.0"
description: "Entity for system user management - Updated dependencies"

fields:
  - name: "Id"
    type: "int"
    primaryKey: true
    autoIncrement: true
    required: true
    nullable: false
    description: "Unique user identifier"
  - name: "Username"
    type: "string"
    maxLength: 50
    required: true
    nullable: false
    description: "Unique username"
  - name: "PasswordHash"
    type: "string"
    maxLength: 255
    required: true
    nullable: false
    description: "Password hash"
  - name: "Email"
    type: "string"
    maxLength: 100
    required: true
    nullable: false
    description: "Email address"
  - name: "FirstName"
    type: "string"
    maxLength: 50
    required: false
    nullable: true
    description: "User's first name"
  - name: "LastName"
    type: "string"
    maxLength: 50
    required: false
    nullable: true
    description: "User's last name"
  - name: "status"
    type: "string"
    defaultValue: "active"
    catalog: "statuses"
    required: false
    nullable: true
    description: "User status"
  - name: "CreatedAt"
    type: "DateTime"
    defaultValue: "CURRENT_TIMESTAMP_UTC"
    required: true
    nullable: false
    description: "Creation date"
  - name: "UpdatedAt"
    type: "DateTime"
    defaultValue: "CURRENT_TIMESTAMP_UTC"
    required: true
    nullable: false
    description: "Last update date"

catalogs:
  statuses:
    - name: "active"
      description: "Active user"
    - name: "inactive"
      description: "Inactive user"
    - name: "banned"
      description: "Banned user"

statements:
  - name: "Insert"
    type: "Insert"
    return: "nothing"
    description: "Create a new user"
    sql: |
      INSERT INTO Users (Username, PasswordHash, Email, FirstName, LastName, status)
      VALUES (@Username, @PasswordHash, @Email, @FirstName, @LastName, @status);
  - name: "Update"
    type: "Update"
    return: "nothing"
    description: "Update an existing user"
    sql: |
      UPDATE Users 
      SET Username = @Username,
          PasswordHash = @PasswordHash,
          Email = @Email,
          FirstName = @FirstName,
          LastName = @LastName,
          status = @status,
          UpdatedAt = GETUTCDATE()
      WHERE Id = @Id;
  - name: "DeleteById"
    type: "Delete"
    return: "nothing"
    description: "Delete a user by ID"
    sql: |
      DELETE FROM Users 
      WHERE Id = @Id;
  - name: "GetAll"
    type: "Select"
    return: "many"
    description: "Get all users ordered by creation date"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      ORDER BY CreatedAt DESC;
  - name: "GetById"
    type: "Select"
    return: "one"
    description: "Get a user by ID"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE Id = @Id;
  - name: "GetByUser"
    type: "Select"
    return: "one"
    description: "Get a user by username"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE Username = @Username;
  - name: "GetByStatus"
    type: "Select"
    return: "many"
    description: "Get users filtered by status"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE status = @status
      ORDER BY CreatedAt DESC;
  - name: "GetActiveCount"
    type: "Select"
    return: "scalar"
    description: "Get count of active users"
    sql: |
      SELECT COUNT(*)
      FROM Users
      WHERE status = 'active';
  - name: "GetByEmailAndStatus"
    type: "Select"
    return: "many"
    description: "Advanced user search"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt,
             CONCAT(FirstName, ' ', LastName) as Name,
             CASE 
               WHEN status = 'active' THEN 'Active'
               WHEN status = 'inactive' THEN 'Inactive'
               WHEN status = 'banned' THEN 'Banned'
               ELSE 'Unknown'
             END as Status
      FROM Users 
      WHERE (@searchTerm IS NULL OR CONCAT(FirstName, ' ', LastName) LIKE CONCAT('%', @searchTerm, '%') 
             OR Email LIKE CONCAT('%', @searchTerm, '%'))
        AND (@statusFilter IS NULL OR status = @statusFilter)
      ORDER BY CreatedAt DESC;