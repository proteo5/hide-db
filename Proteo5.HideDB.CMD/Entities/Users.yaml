# Description: This file defines the Users entity for the Proteo5.HideDB.CMD project.
entity: "Users"
entityversion: "1"
version: "1.0"
description: "Entidad para gestión de usuarios del sistema - Updated dependencies"

fields:
  - name: "Id"
    type: "int"
    primaryKey: true
    autoIncrement: true
    required: true
    nullable: false
    description: "Identificador único del usuario"
  - name: "Username"
    type: "string"
    maxLength: 50
    required: true
    nullable: false
    description: "Nombre de usuario único"
  - name: "PasswordHash"
    type: "string"
    maxLength: 255
    required: true
    nullable: false
    description: "Hash de la contraseña"
  - name: "Email"
    type: "string"
    maxLength: 100
    required: true
    nullable: false
    description: "Dirección de correo electrónico"
  - name: "FirstName"
    type: "string"
    maxLength: 50
    required: false
    nullable: true
    description: "Nombre del usuario"
  - name: "LastName"
    type: "string"
    maxLength: 50
    required: false
    nullable: true
    description: "Apellido del usuario"
  - name: "status"
    type: "string"
    defaultValue: "active"
    catalog: "statuses"
    required: false
    nullable: true
    description: "Estado del usuario"
  - name: "CreatedAt"
    type: "DateTime"
    defaultValue: "CURRENT_TIMESTAMP_UTC"
    required: true
    nullable: false
    description: "Fecha de creación"
  - name: "UpdatedAt"
    type: "DateTime"
    defaultValue: "CURRENT_TIMESTAMP_UTC"
    required: true
    nullable: false
    description: "Fecha de última actualización"

catalogs:
  statuses:
    - name: "active"
      description: "Usuario activo"
    - name: "inactive"
      description: "Usuario inactivo"
    - name: "banned"
      description: "Usuario baneado"

statements:
  - name: "Insert"
    type: "Insert"
    return: "nothing"
    description: "Crea un nuevo usuario"
    sql: |
      INSERT INTO Users (Username, PasswordHash, Email, FirstName, LastName, status)
      VALUES (@Username, @PasswordHash, @Email, @FirstName, @LastName, @status);
  - name: "Update"
    type: "Update"
    return: "nothing"
    description: "Actualiza un usuario existente"
    sql: |
      UPDATE Users 
      SET Username = @Username,
          PasswordHash = @PasswordHash,
          Email = @Email,
          FirstName = @FirstName,
          LastName = @LastName,
          status = @status,
          UpdatedAt = GETUTCDATE()
      WHERE Id = @Id;
  - name: "DeleteById"
    type: "Delete"
    return: "nothing"
    description: "Elimina un usuario por ID"
    sql: |
      DELETE FROM Users 
      WHERE Id = @Id;
  - name: "GetAll"
    type: "Select"
    return: "many"
    description: "Obtiene todos los usuarios ordenados por fecha de creación"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      ORDER BY CreatedAt DESC;
  - name: "GetById"
    type: "Select"
    return: "one"
    description: "Obtiene un usuario por su ID"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE Id = @Id;
  - name: "GetByUser"
    type: "Select"
    return: "one"
    description: "Obtiene un usuario por nombre de usuario"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE Username = @Username;
  - name: "GetByStatus"
    type: "Select"
    return: "many"
    description: "Obtiene usuarios filtrados por estado"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE status = @status
      ORDER BY CreatedAt DESC;
  - name: "GetActiveCount"
    type: "Select"
    return: "scalar"
    description: "Obtiene el conteo de usuarios activos"
    sql: |
      SELECT COUNT(*)
      FROM Users
      WHERE status = 'active';
  - name: "GetByEmailAndStatus"
    type: "Select"
    return: "many"
    description: "Búsqueda avanzada de usuarios"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt,
             CONCAT(FirstName, ' ', LastName) as Name,
             CASE 
               WHEN status = 'active' THEN 'Activo'
               WHEN status = 'inactive' THEN 'Inactivo'
               WHEN status = 'banned' THEN 'Baneado'
               ELSE 'Desconocido'
             END as Status
      FROM Users 
      WHERE (@searchTerm IS NULL OR CONCAT(FirstName, ' ', LastName) LIKE CONCAT('%', @searchTerm, '%') 
             OR Email LIKE CONCAT('%', @searchTerm, '%'))
        AND (@statusFilter IS NULL OR status = @statusFilter)
      ORDER BY CreatedAt DESC;      ORDER BY CreatedAt DESC;