# Description: This file defines the Users entity for the Proteo5.HideDB.CMD project.
entity: "Users"
entityversion: "1"
version: "1.0"

fields:
  - name: "Id"
    type: "int"
    primaryKey: true
    autoIncrement: true
  - name: "Username"
    type: "string"
    maxLength: 50
  - name: "PasswordHash"
    type: "string"
    maxLength: 255
  - name: "Email"
    type: "string"
    maxLength: 100
  - name: "FirstName"
    type: "string"
    maxLength: 50
  - name: "LastName"
    type: "string"
    maxLength: 50
  - name: "status"
    type: "string"
    defaultValue: "active"
    catalog: "statuses"
  - name: "CreatedAt"
    type: "DateTime"
    defaultValue: "CURRENT_TIMESTAMP_UTC"
  - name: "UpdatedAt"
    type: "DateTime"
    defaultValue: "CURRENT_TIMESTAMP_UTC"

catalogs:
  statuses:
    - name: "active"
    - name: "inactive"
    - name: "banned"

statements:
  - name: "Insert"
    type: "Insert"
    return: "nothing"
    sql: |
      INSERT INTO Users (Username, PasswordHash, Email, FirstName, LastName, status)
      VALUES (@Username, @PasswordHash, @Email, @FirstName, @LastName, @status);
  - name: "Update"
    type: "Update"
    return: "nothing" 
    sql: |
      UPDATE Users 
      SET Username = @Username,
          PasswordHash = @PasswordHash,
          Email = @Email,
          FirstName = @FirstName,
          LastName = @LastName,
          status = @status,
          UpdatedAt = CURRENT_TIMESTAMP_UTC
      WHERE Id = @Id;
  - name: "DeleteById"
    type: "Delete"
    return: "nothing"
    sql: |
      DELETE FROM Users 
      WHERE Id = @Id;
  - name: "GetAll"
    type: "Select"
    return: "many"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      ORDER BY CreatedAt DESC;
  - name: "GetById"
    type: "Select"
    return: "one"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE Id = @Id;
  - name: "GetByUser"
    type: "Select"
    return: "one"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE Username = @Username;
  - name: "GetByStatus"
    type: "Select"
    return: "many"
    sql: |
      SELECT Id, Username, PasswordHash, Email, FirstName, LastName, status, CreatedAt, UpdatedAt
      FROM Users
      WHERE status = @status
      ORDER BY CreatedAt DESC;
  - name: "GetActiveCount"
    type: "Select"
    return: "scalar"
    sql: |
      SELECT COUNT(*)
      FROM Users
      WHERE status = 'active';
  - name: "GetByEmailAndStatus"
    type: "Select"
    return: "many"
    sql: |
      SELECT Id, 
             CONCAT(FirstName, ' ', LastName) as Name, 
             Email,
             CASE 
               WHEN status = 'active' THEN 'Activo'
               WHEN status = 'inactive' THEN 'Inactivo'
               WHEN status = 'banned' THEN 'Baneado'
               ELSE 'Desconocido'
             END as Status
      FROM Users 
      WHERE (@searchTerm IS NULL OR CONCAT(FirstName, ' ', LastName) LIKE CONCAT('%', @searchTerm, '%') 
             OR Email LIKE CONCAT('%', @searchTerm, '%'))
        AND (@statusFilter IS NULL OR status = @statusFilter)
      ORDER BY CreatedAt DESC;